<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/witsGoLogo.png" type="image/x-icon">
    <title>WitsGo</title>
    <link rel="stylesheet" href="styles/splash.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

    <script defer src="https://unpkg.com/axios/dist/axios.min.js"></script>


    <!-- <script type="module" defer src="scripts/verifylogin.js"></script> This script should be put on everypage -->



    <script defer type="module">
        import { clientUrl, serverUrl } from "./scripts/constants.js";

        // Wait 2 seconds then navigate to the new URL
        setTimeout(async () => {
            // return;

            // if server redirected us here after error, display servermessage query param
            const urlParams = new URLSearchParams(window.location.search);
            const serverMessage = urlParams.get('servermessage');
            if (serverMessage) {
                console.log("Server message: ", serverMessage);
                alert(serverMessage);
            }

            let response
            try {
                response = await axios.get(`${serverUrl}/verifylogin`, { withCredentials: true });
                console.log("Login, 200 OK", response.data);
            } catch (error) {
                console.log("Error: ", error);
                window.location.href = `${clientUrl}/authorize`;
                return;
            }

            if (!response.data.isLoggedIn) {
                console.log("User is not logged in");
                window.location.href = `${clientUrl}/authorize`;
                return;
            }

            // get latest user from database
            let userResponse
            try {
                userResponse = await axios.get(`${serverUrl}/user/${response.data.user.user.email}`, { withCredentials: true });
                console.log("User, 200 OK", userResponse.data);
            } catch (error) {
                console.log("Error: ", error);
                window.location.href = `${clientUrl}/authorize`;
                return;
            }

            // Set local storage
            localStorage.clear();
            if (userResponse.data.user) {
                console.log("userResponse.data.user", userResponse.data.user);

                localStorage.setItem("firstName", userResponse.data.user.firstName);
                localStorage.setItem("lastName", userResponse.data.user.lastName);
                localStorage.setItem("picture", userResponse.data.user.picture);
                localStorage.setItem("onWheelChair", userResponse.data.user.onWheelChair);
                localStorage.setItem("age", userResponse.data.user.age);
                localStorage.setItem("email", userResponse.data.user.email);
                localStorage.setItem("role", userResponse.data.user.role);

                let firstPage;
                if (userResponse.data.user.role === "student") {
                    firstPage = clientUrl + "/navigation";
                } else {
                    firstPage = clientUrl + "/driverpage";
                }

                console.log("FROM index.html, userResponse.data.user.rol", userResponse.data.user.rol);

                setTimeout(() => {
                    window.location.href = firstPage;
                }, 1000);
            } else {
                console.log("userResponse is null");
                setTimeout(() => {
                    window.location.href = clientUrl + "/authorize";
                }, 1000);
            }





        }, 1000);

    </script>
</head>

<body>
    <section class="logo-thing">
        <img src="images/witsGoLogo.png" alt="Wits Go Logo">
        <h1>Wits Go</h1>
    </section>
    <div class="bottom">
        <section class="slogan">Destinations made easy</section>
    </div>

</body>

</html>