<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Schedule</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Roboto:wght@400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles/busSchedule.css">
    <link rel="stylesheet" href="styles/navBar.css">

    <script defer src="https://unpkg.com/axios/dist/axios.min.js"></script>


    <script type="module" defer src="scripts/verifylogin.js"></script> <!-- This script should be put on everypage -->


</head>

<body>
    <section class="header">
        <section class="profile-icon">
            <img src="icons/profile.png" alt="Profile">
        </section>
        <h1 class="title">Bus Schedule</h1>
    </section>


    <div class="dropdown-container">
        <select name="days" id="days">
            <option value="" disabled selected>Days:</option>
            <option value="Week">Monday-Friday</option>
            <option value="Weekend">Saturday-Sunday and Public Holidays</option>
        </select>

        <select name="destination" id="destination">
            <option value="" disabled selected>Destinations:</option>
            <option value="AMIC">AMIC DECK- AMIC</option>
            <option value="EOH">ERNST OPPENHEIMER HALL OF RESIDENCE- EOH</option>
            <option value="KNK">KNOCKANDO HALLS OF RESIDENCE- KNK</option>
            <option value="NSW">NOSWAL HALL (1 STIEMENS STREET, BRAAMFONTEIN)- NSW</option>
            <option value="ROSEBANK" id="rosebank-option">ROSEBANK MALL- ROSEBANK</option>
            <option value="WEC">WITS EDUCATION CAMPUS- WEC</option>
            <option value="WJ">WITS JUNCTION RESIDENCE- WJ</option>
        </select>
    </div>

    <section class="schedule-container">
        <!--for bus schedule -->
    </section>

    <section class="navbar">
        <a href="navigation.html">
            <img src="icons/nav-grey.png" alt="Nav Icon">
            <section class="text">Navigation</section>
        </a>
        <a href="rental.html">
            <img src="icons/rent-grey.png" alt="Rent Icon">
            <section class="text">Renting</section>
        </a>
        <a href="busSchedule.html">
            <img src="icons/schedule-purple.png" alt="Schedule Icon">
            <section class="text">Schedule</section>
        </a>
        <a href="realTimeTracking.html">
            <img src="icons/tracking-grey.png" alt="Tracking Icon">
            <section class="text">Tracking</section>
        </a>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        document.querySelector('.schedule-container').addEventListener('click', function () {
            this.classList.toggle('expanded');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const scheduleContainer = document.querySelector('.schedule-container');
            let fullText = '';

            fetch('https://witsgobackend.azurewebsites.net/v1/schedule/pdf-text')
                .then(response => response.text())
                .then(data => {
                    fullText = data;
                    updateSchedule();
                })
                .catch(err => {
                    console.error('Error fetching the PDF text:', err);
                });

            const updateSchedule = () => {
                const dayValue = document.getElementById('days').value;
                const destinationValue = document.getElementById('destination').value;

                let displayText = '';

                if (dayValue === 'Week') {
                    displayText = extractText(fullText, 'MONDAY TO FRIDAY', 'CONTACT US');
                    //Remove Rosebank option if not Weekend 
                    document.getElementById('rosebank-option').style.display = 'none';
                } else if (dayValue === 'Weekend') {
                    displayText = extractText(fullText, 'SATURDAY AND SUNDAY', 'â€¢');
                    document.getElementById('rosebank-option').style.display = 'block';
                } else {
                    displayText = fullText;
                    document.getElementById('rosebank-option').style.display = 'block';
                }

                if (destinationValue) {
                    displayText = filterByDestination(displayText, destinationValue);
                }

                scheduleContainer.innerHTML = displayText || fullText;
            };

            const extractText = (text, startKeyword, endKeyword) => {
                const startIndex = text.indexOf(startKeyword);
                const endIndex = text.indexOf(endKeyword);

                if (startIndex === -1 || endIndex === -1 || startIndex >= endIndex) {
                    return '';
                }

                return text.substring(startIndex, endIndex).trim();
            };

            const filterByDestination = (text, destination) => {
                const routeStartKeyword = 'Route';
                const destinationKeyword = destination;
                let filteredText = '';
                let index = 0;

                while (index < text.length) {
                    const routeStartIndex = text.indexOf(routeStartKeyword, index);
                    if (routeStartIndex === -1) break;

                    const routeEndIndex = text.indexOf(routeStartKeyword, routeStartIndex + routeStartKeyword.length);
                    const routeText = text.substring(routeStartIndex, routeEndIndex !== -1 ? routeEndIndex : undefined);

                    if (routeText.includes(destinationKeyword)) {
                        filteredText += routeText + '<br><br>';
                    }

                    index = routeEndIndex !== -1 ? routeEndIndex : text.length;
                }

                return filteredText;
            };

            document.getElementById('days').addEventListener('change', updateSchedule);
            document.getElementById('destination').addEventListener('change', updateSchedule);
        });
    </script>
</body>

</html>